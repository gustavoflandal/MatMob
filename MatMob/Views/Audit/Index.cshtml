@model IEnumerable<MatMob.Models.Entities.AuditLog>

@{
    ViewData["Title"] = "Logs de Auditoria";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-history"></i> Logs de Auditoria
                    </h3>
                    <div class="card-tools">
                        <a href="@Url.Action("Dashboard", "Audit")" class="btn btn-info btn-sm">
                            <i class="fas fa-chart-bar"></i> Dashboard
                        </a>
                        <a href="@Url.Action("Export", "Audit", new { format = "csv" })" class="btn btn-success btn-sm">
                            <i class="fas fa-download"></i> Exportar CSV
                        </a>
                        <a href="@Url.Action("Export", "Audit", new { format = "json" })" class="btn btn-primary btn-sm">
                            <i class="fas fa-download"></i> Exportar JSON
                        </a>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Filtros -->
                    <form method="get" class="mb-4">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="searchString">Buscar</label>
                                    <input type="text" class="form-control" id="searchString" name="searchString"
                                           value="@ViewData["CurrentFilter"]" placeholder="Nome da entidade, descrição...">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="userName">Usuário</label>
                                    <select class="form-control" id="userName" name="userName">
                                        <option value="">Todos</option>
                                        @foreach (var user in ViewBag.Users)
                                        {
                                            <option value="@user" selected="@(ViewData["UserNameFilter"]?.ToString() == user)">
                                                @user
                                            </option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="action">Ação</label>
                                    <select class="form-control" id="action" name="action">
                                        <option value="">Todas</option>
                                        @foreach (var act in ViewBag.Actions)
                                        {
                                            <option value="@act" selected="@(ViewData["ActionFilter"]?.ToString() == act)">
                                                @act
                                            </option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="category">Categoria</label>
                                    <select class="form-control" id="category" name="category">
                                        <option value="">Todas</option>
                                        @foreach (var cat in ViewBag.Categories)
                                        {
                                            <option value="@cat" selected="@(ViewData["CategoryFilter"]?.ToString() == cat)">
                                                @cat
                                            </option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Data Inicial</label>
                                    <input type="date" class="form-control" name="startDate"
                                           value="@ViewData["StartDateFilter"]">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Data Final</label>
                                    <input type="date" class="form-control" name="endDate"
                                           value="@ViewData["EndDateFilter"]">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="severity">Severidade</label>
                                    <select class="form-control" id="severity" name="severity">
                                        <option value="">Todas</option>
                                        @foreach (var sev in ViewBag.Severities)
                                        {
                                            <option value="@sev" selected="@(ViewData["SeverityFilter"]?.ToString() == sev)">
                                                @sev
                                            </option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="submit" class="btn btn-primary btn-block">
                                        <i class="fas fa-search"></i> Filtrar
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <a href="@Url.Action("Index", "Audit")" class="btn btn-secondary btn-block">
                                        <i class="fas fa-times"></i> Limpar
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Tabela de Logs -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usuário</th>
                                    <th>Ação</th>
                                    <th>Entidade</th>
                                    <th>Descrição</th>
                                    <th>Categoria</th>
                                    <th>Severidade</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Any())
                                {
                                    @foreach (var log in Model)
                                    {
                                        <tr>
                                            <td>@log.Timestamp.ToString("dd/MM/yyyy HH:mm:ss")</td>
                                            <td>@log.UserName</td>
                                            <td>
                                                <span class="badge badge-primary">@log.Action</span>
                                            </td>
                                            <td>@log.EntityName</td>
                                            <td>
                                                <span title="@log.Description">
                                                    @(log.Description?.Length > 50 ? log.Description.Substring(0, 50) + "..." : log.Description)
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge badge-info">@log.Category</span>
                                            </td>
                                            <td>
                                                @switch (log.Severity)
                                                {
                                                    case "CRITICAL":
                                                        <span class="badge badge-danger">CRÍTICO</span>
                                                        break;
                                                    case "ERROR":
                                                        <span class="badge badge-danger">ERRO</span>
                                                        break;
                                                    case "WARNING":
                                                        <span class="badge badge-warning">AVISO</span>
                                                        break;
                                                    case "INFO":
                                                        <span class="badge badge-info">INFO</span>
                                                        break;
                                                    case "DEBUG":
                                                        <span class="badge badge-secondary">DEBUG</span>
                                                        break;
                                                    default:
                                                        <span class="badge badge-secondary">@log.Severity</span>
                                                        break;
                                                }
                                            </td>
                                            <td>
                                                <a href="@Url.Action("Details", "Audit", new { id = log.Id })"
                                                   class="btn btn-sm btn-info">
                                                    <i class="fas fa-eye"></i> Detalhes
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <i class="fas fa-info-circle"></i> Nenhum log de auditoria encontrado.
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginação -->
                    @if (ViewBag.TotalPages > 1)
                    {
                        <nav aria-label="Paginação">
                            <ul class="pagination justify-content-center">
                                @if (ViewBag.CurrentPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action("Index", "Audit", new {
                                            page = ViewBag.CurrentPage - 1,
                                            searchString = ViewData["CurrentFilter"],
                                            userName = ViewData["UserNameFilter"],
                                            action = ViewData["ActionFilter"],
                                            category = ViewData["CategoryFilter"],
                                            severity = ViewData["SeverityFilter"],
                                            startDate = ViewData["StartDateFilter"],
                                            endDate = ViewData["EndDateFilter"]
                                        })">Anterior</a>
                                    </li>
                                }

                                @for (int i = Math.Max(1, ViewBag.CurrentPage - 2); i <= Math.Min(ViewBag.TotalPages, ViewBag.CurrentPage + 2); i++)
                                {
                                    <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                        <a class="page-link" href="@Url.Action("Index", "Audit", new {
                                            page = i,
                                            searchString = ViewData["CurrentFilter"],
                                            userName = ViewData["UserNameFilter"],
                                            action = ViewData["ActionFilter"],
                                            category = ViewData["CategoryFilter"],
                                            severity = ViewData["SeverityFilter"],
                                            startDate = ViewData["StartDateFilter"],
                                            endDate = ViewData["EndDateFilter"]
                                        })">@i</a>
                                    </li>
                                }

                                @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action("Index", "Audit", new {
                                            page = ViewBag.CurrentPage + 1,
                                            searchString = ViewData["CurrentFilter"],
                                            userName = ViewData["UserNameFilter"],
                                            action = ViewData["ActionFilter"],
                                            category = ViewData["CategoryFilter"],
                                            severity = ViewData["SeverityFilter"],
                                            startDate = ViewData["StartDateFilter"],
                                            endDate = ViewData["EndDateFilter"]
                                        })">Próximo</a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    }

                    <!-- Informações de paginação -->
                    <div class="row mt-3">
                        <div class="col-12 text-center text-muted">
                            Mostrando @(((ViewBag.CurrentPage - 1) * ViewBag.PageSize) + 1) -
                            @Math.Min(ViewBag.CurrentPage * ViewBag.PageSize, ViewBag.TotalRecords)
                            de @ViewBag.TotalRecords registros
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>