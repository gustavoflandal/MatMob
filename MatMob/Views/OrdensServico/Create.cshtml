@model MatMob.Models.Entities.OrdemServico
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Nova Ordem de Serviço";
}

<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="display-6 mb-0">
            <i class="fas fa-plus text-primary me-2"></i>Nova Ordem de Serviço
        </h1>
        <p class="text-muted">Criar nova ordem de serviço</p>
    </div>
    <div class="col-md-4 text-end">
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Voltar
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form asp-action="Create" method="post">
            <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label asp-for="NumeroOS" class="form-label">Número da OS</label>
                        <input asp-for="NumeroOS" id="NumeroOS" class="form-control" readonly>
                        <span asp-validation-for="NumeroOS" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label asp-for="AtivoId" class="form-label">Ativo *</label>
                        <select asp-for="AtivoId" id="AtivoId" class="form-select" asp-items="@((SelectList)ViewData["AtivoId"])">
                            <option value="">Selecione o ativo</option>
                        </select>
                        <span asp-validation-for="AtivoId" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label asp-for="TipoServico" class="form-label">Tipo de Serviço *</label>
                        <select asp-for="TipoServico" id="TipoServico" class="form-select" asp-items="Html.GetEnumSelectList<MatMob.Models.Entities.TipoServico>()">
                            <option value="">Selecione o tipo</option>
                        </select>
                        <span asp-validation-for="TipoServico" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label asp-for="Prioridade" class="form-label">Prioridade *</label>
                        <select asp-for="Prioridade" id="Prioridade" class="form-select" asp-items="Html.GetEnumSelectList<MatMob.Models.Entities.PrioridadeOS>()">
                        </select>
                        <span asp-validation-for="Prioridade" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label asp-for="CustoEstimado" class="form-label">Custo Estimado</label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <input asp-for="CustoEstimado" id="CustoEstimado" class="form-control" type="number" step="0.01" min="0" placeholder="0,00">
                        </div>
                        <span asp-validation-for="CustoEstimado" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="DescricaoProblema" class="form-label">Descrição do Problema *</label>
                <textarea asp-for="DescricaoProblema" id="DescricaoProblema" class="form-control" rows="4" 
                          placeholder="Descreva detalhadamente o problema ou serviço a ser realizado"></textarea>
                <span asp-validation-for="DescricaoProblema" class="text-danger"></span>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label asp-for="EquipeId" class="form-label">Equipe</label>
                        <select asp-for="EquipeId" id="EquipeId" class="form-select" asp-items="@((SelectList)ViewData["EquipeId"])">
                            <option value="">Selecione a equipe (opcional)</option>
                        </select>
                        <span asp-validation-for="EquipeId" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label asp-for="TecnicoResponsavelId" class="form-label">Técnico Responsável</label>
                        <select asp-for="TecnicoResponsavelId" id="TecnicoResponsavelId" class="form-select" asp-items="@((SelectList)ViewData["TecnicoResponsavelId"])">
                            <option value="">Selecione o técnico responsável (opcional)</option>
                        </select>
                        <span asp-validation-for="TecnicoResponsavelId" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <hr>

            <div class="row">
                <div class="col-md-12 text-end">
                    <a asp-action="Index" class="btn btn-secondary me-2">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Criar OS
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Validação customizada no envio do formulário
            $('form').on('submit', function(e) {
                var isValid = true;
                var errors = [];
                
                // Validar Ativo
                var ativoId = $('#AtivoId').val();
                if (!ativoId || ativoId === '') {
                    errors.push('Por favor, selecione um ativo.');
                    $('#AtivoId').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#AtivoId').removeClass('is-invalid').addClass('is-valid');
                }
                
                // Validar Tipo de Serviço
                var tipoServico = $('#TipoServico').val();
                if (!tipoServico || tipoServico === '') {
                    errors.push('Por favor, selecione o tipo de serviço.');
                    $('#TipoServico').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#TipoServico').removeClass('is-invalid').addClass('is-valid');
                }
                
                // Validar Descrição do Problema
                var descricao = $('#DescricaoProblema').val().trim();
                if (!descricao || descricao === '') {
                    errors.push('Por favor, descreva o problema ou serviço.');
                    $('#DescricaoProblema').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#DescricaoProblema').removeClass('is-invalid').addClass('is-valid');
                }
                
                // Exibir erros se houver
                if (!isValid) {
                    e.preventDefault();
                    
                    // Criar ou atualizar alert de erro
                    var alertHtml = '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                        '<h6><i class="fas fa-exclamation-triangle me-2"></i>Por favor, corrija os seguintes erros:</h6>' +
                        '<ul class="mb-0">';
                    
                    errors.forEach(function(error) {
                        alertHtml += '<li>' + error + '</li>';
                    });
                    
                    alertHtml += '</ul>' +
                        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                        '</div>';
                    
                    // Remover alertas existentes e adicionar novo
                    $('.alert-danger').remove();
                    $('form').prepend(alertHtml);
                    
                    // Scroll para o topo do formulário
                    $('html, body').animate({
                        scrollTop: $('form').offset().top - 20
                    }, 300);
                }
                
                return isValid;
            });
            
            // Remover classe de erro quando o usuário corrigir
            $('#AtivoId, #TipoServico, #DescricaoProblema').on('change input', function() {
                $(this).removeClass('is-invalid');
                
                // Se todos os campos obrigatórios estiverem preenchidos, remover alert
                var ativoOk = $('#AtivoId').val() && $('#AtivoId').val() !== '';
                var tipoOk = $('#TipoServico').val() && $('#TipoServico').val() !== '';
                var descricaoOk = $('#DescricaoProblema').val().trim() !== '';
                
                if (ativoOk && tipoOk && descricaoOk) {
                    $('.alert-danger').fadeOut();
                }
            });
            
            console.log('Validação de formulário OS inicializada');
        });
    </script>
}
